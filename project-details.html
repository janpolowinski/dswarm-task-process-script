<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
        <!--<link type="text/css" rel="stylesheet" href="css/main.css"/>-->
        <!--<script type="text/javascript" src="libs/d3.min.js"></script>-->
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <!--<script type="text/javascript" src="settings.js"></script>-->
        <style type="text/css">
        	body { font-family: "Arial"; font-size: 0.9em; }
        	.currentSelection { font-weight: bold ; color: red ; }
        	#metricsView { position:absolute; top:0px; right:0px; margin:1em; background-color:white ; }
        	.mapping:hover {background-color:#dcc ; }
        	td,th {width:33% ; }
        	table {width:100% ; }
        </style>
    </head>
    <body>

    <div id="projectsView"><h2>Projects</h2></div>
    <div id="projectDetailsView"><h3>Project Details</h3></div>
    <div>
    <table style="padding:10px">
		<tr>
			<th>mapping name</th>
			<th>filter (of IAP 0) - datafield/tag</th>
			<th>subfield/code</th>
		<tr>
	</table>
	    <table id="projectDetailsTable" style="padding:10px">
	    </table>
    </div>
    
    
    <script type="text/javascript">
    
    /* SETTINGS */
//	var baseUrlBackend = "http://127.0.0.1:8087/dmp/";
//  var baseUrlBackend = "http://sdvdmpdev.slub-dresden.de/dmp/";
    var baseUrlBackend = "http://194.95.145.44/dmp/";
    
   
    /* PAGE BUILDING */
    
    var contents = d3.select("body");

    
    // list projects
    d3.json(baseUrlBackend + "projects", function (error, result) {
    	
    	var lis = contents.select("#projectsView")
    		.append("div").append("ul")
    		.selectAll("li.project")
    		.data(result.sort(function(a, b) { return d3.ascending(a.name, b.name); }))
    		;
    	
    	lis.enter()
    		.append("li")
    		.attr("class", "project")
    		.text(function(d){ return d.name + " " ; })
    		.attr("title", function(d){ return d.description + " (" + d.uuid + ")"; })
    		;
    	
    	lis.append("button")
			.attr("onclick", function(d){
			return "updateMappingDetails('" + d.uuid + "') ; ";
				})
		.text(function(d){return "Show detailed mappings" ;})
		;
    });

    /* FUNCTIONS */
    
 function updateMappingDetails(projectID) {
        
        // get project and build job
        d3.json(baseUrlBackend + "projects/" + projectID, function (error, result) {
        	
        	var currentProject = result;
            
            contents.select("#projectDetailsTable").selectAll("tr").remove();
            
            var mappingTable = contents.select("#projectDetailsTable")
    		.selectAll("tr.mapping")
    		.data(currentProject.mappings.sort(function(a, b) { return d3.ascending(a.name, b.name); }))
    		;
            
            var rowEnter = mappingTable.enter()
    		.append("tr")
    		.attr("class", "mapping")
    		.attr("title", function(d){ return " (" + d.uuid + ")"; });
            
            rowEnter.append("td")
    		.text(function(d){ return d.name ; });
            
            rowEnter.filter(function(d){return null != d.input_attribute_paths[0].filter}).append("td")
    		.text(function(d){ return getTagValueFromFilter(d.input_attribute_paths[0].filter.expression); });

            rowEnter.filter(function(d){return null != d.input_attribute_paths[0].filter}).append("td")
    		.text(function(d){ return getCodeValueFromFilter(d.input_attribute_paths[0].filter.expression) + 
    			// check for usage of ID, since this may be have been done accidentally
    			getIDValueFromFilter(d.input_attribute_paths[0].filter.expression) ; });

        });
        }
 
function getTagValueFromFilter(expressionString) {
	if (null!=expressionString) {
	    var re = /^.*#tag":"([^"]*)"\}.*/; 
	    var matches = expressionString.match(re);
        if (matches == null) return "";
        else return matches[1];
	} else return "";
}
   
function getCodeValueFromFilter(expressionString) {
	if (null!=expressionString) {
	    var re = /^.*#code":"([^"]*)"\}.*/; 
	    var matches = expressionString.match(re);
        if (matches == null) return "";
        else return matches[1];
	} else return "";
}

function getIDValueFromFilter(expressionString) {
	if (null!=expressionString) {
	    var re = /^.*#id":"([^"]*)"\}.*/; 
	    var matches = expressionString.match(re);
        if (matches != null) return " !!!!!!!!!!!!! ID was used somewhere in Filter! Intentionally? !!!!!!!!!!!!!!!!";
        else return "";
	} else return "";
}

    </script>
    </body>
</html>
