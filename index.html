<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
        <!--<link type="text/css" rel="stylesheet" href="css/main.css"/>-->
        <script type="text/javascript" src="libs/d3.min.js"></script>
        <!--<script type="text/javascript" src="settings.js"></script>-->
    </head>
    <body>
    
    <h1>Current Task Configuration</h1>
    <ul id="taskConfigView">
    	<li id="projectID"><span>projectID: </span><span class="value"> ... </span></li>
    	<li id="inputDatamodelID"><span>inputDatamodelID: </span><span class="value"> ... </span></li>
    	<li id="outputDatamodelID"><span>outputDatamodelID: </span><span class="value"> ... </span></li>
    <ul>
    
    <div style="margin-top:1em">
    	<button style="color:red" onClick="buildJobAndRunTask()">Run Task</button>
    </div>
    
    <script type="text/javascript">
    
    /* SETTINGS */
    var baseUrlBackend = "http://localhost:8087/dmp/";
    
    /* PARAMETERS */
    var projectID = "21840fd7-ff93-83ff-6106-18948199f8b6";
    var inputDatamodelID = "2ff8370e-3825-bf79-f66d-4d67c31eb67c";
    var outputDatamodelID = "DataModel-cf998267-392a-4d87-a33a-88dd1bffb016";
    
    var taskConfig = {};
    taskConfig.projectID = projectID;
    taskConfig.inputDatamodelID = inputDatamodelID;
    taskConfig.outputDatamodelID = outputDatamodelID;
    
    /* GLOBALS */
    var currentProject;
    var currentJob;
    var currentInputDatamodel;
    var currentOutputDatamodel;
    
    /* FUNCTIONS */
    
    var buildJob = function(project) {
    	var job = {};
    	job.name = "Job derived from project '" + project.name + "'";
    	job.mappings = project.mappings;
    	return job;
    };
    
    var buildTask = function(job, inputDatamodel, outputDatamodel) {
    	var task = {};
    	task.name = "" +
    		"Task (based on project '" + job.name + 
    		"', in: " +	inputDatamodel.id + 
    		", out: " + outputDatamodel.id;
    	task.job = job;
    	task.input_data_model = inputDatamodel;
    	task.output_data_model = outputDatamodel;
    	return task;
    };
    
    
    function updateParameterView() {
    	
    	contents.select("#projectID").select("span.value").text(projectID);
    	contents.select("#inputDatamodelID").select("span.value").text(inputDatamodelID);
    	contents.select("#outputDatamodelID").select("span.value").text(outputDatamodelID);
    	
    	//.style("background-color", "black").transition().duration(500).style("background-color", "white");
    }
    
    function buildJobAndRunTask() {
        
        // get project and build job
        d3.json(baseUrlBackend + "projects/" + projectID, function (error, result) {
        	
        	currentProject = result;
            currentJob = buildJob(currentProject);
        	//console.log(currentJob);
        	
            // get input data model
            d3.json(baseUrlBackend + "datamodels/" + inputDatamodelID, function (error, result) {
            	
                currentInputDatamodel = result;
            	//console.log(currentInputDatamodel);

                // get output data model
                d3.json(baseUrlBackend + "datamodels/" + outputDatamodelID, function (error, result) {
                	
                	currentOutputDatamodel = result
                	//console.log(result);
                	currentTask = buildTask(currentJob, currentInputDatamodel, currentOutputDatamodel);
                	//console.log(currentTask);
                	//console.log(JSON.stringify(currentTask));

                	  	// run task
                	  	d3.xhr(baseUrlBackend + "tasks?persist=false")
                	    .header("Content-Type", "application/json;charset=utf-8")
                	    .header("Accept", "application/json, text/plain, */*")
                	    .post(
                	        JSON.stringify(currentTask),
                	        function(err, rawData){
                	        	//console.log(rawData.response);
                	            var transformationResult = JSON.parse(rawData.response);
                    	  		console.log("Transformation results:");
                    	  		console.log(transformationResult);
                	        }
                	    );
                	
            	});	
        	}); 	
    	});   
    }
    
    
    /* PAGE BUILDING */
    
    var contents = d3.select("body");
    
    updateParameterView();
    
    // list projects
    d3.json(baseUrlBackend + "projects", function (error, result) {
    	
    	contents.append("h2").text("Projects");
    	
    	var lis = contents
    		.append("div").append("ul")
    		.selectAll("li.project")
    		.data(result)
//    		.data(result.sort(function(a, b) { return d3.ascending(a.id, b.id); }))
    		;
    	
    	lis.enter()
    		.append("li")
    		.attr("class", "project")
    		.text(function(d){ return d.name + " " ; })
    		.attr("title", function(d){ return d.description; })
    		;
    	
    	lis.append("button")
    		.attr("onclick", function(d){
    			return "projectID = '" + d.uuid + "'; console.log('projectID now ' + projectID); updateParameterView() ; ";
   				})
			.text(function(d){return "Create job from this project (" + d.uuid + ")";})
			;
    	
    });
    
    // list datamodels
    d3.json(baseUrlBackend + "datamodels", function (error, result) {
    	
    	contents.append("h2").text("Datamodels");
    	
    	var lis = contents
    		.append("div").append("ul")
    		.selectAll("li.datamodel")
    		.data(result)
    		;
    	
    	lis.enter()
    		.append("li")
    		.attr("class", "datamodel")
    		.text(function(d){ return d.name + " - " + d.description + " " ; })
    		;
    	
    	// input
    	lis.append("button")
		.attr("onclick", function(d){
			return "inputDatamodelID = '" + d.uuid + "'; console.log('inputDatamodelID now ' + inputDatamodelID); updateParameterView() ; ";
				})
		.text(function(d){return "Use as input (" + d.uuid + ")";})
		;
    	
    	// output
    	lis.append("button")
		.attr("onclick", function(d){
			return "outputDatamodelID = '" + d.uuid + "'; console.log('outputDatamodelID now ' + outputDatamodelID); updateParameterView() ; ";
				})
		.text(function(d){return " .. as output";})
		;

    	
    });

    </script>
    </body>
</html>
