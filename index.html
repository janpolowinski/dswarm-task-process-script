<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
        <!--<link type="text/css" rel="stylesheet" href="css/main.css"/>-->
        <script type="text/javascript" src="libs/d3.min.js"></script>
        <!--<script src="http://d3js.org/d3.v3.min.js"></script>-->
        <!--<script type="text/javascript" src="settings.js"></script>-->
        <style type="text/css">
        	body {font-family: "Arial"; font-size: 0.9em;}
        	.currentSelection { font-weight: bold ; color: red ; }
        </style>
    </head>
    <body>
    
    <h2>Process Step Log+Metrics</h2>
    <div style="margin-top:1em">
	    <ol id="metricsView">
	    </ol>
    </div>
    
    <h2>Current Task Configuration</h2>
    <ul id="taskConfigView">
    	<li id="projectID"><span>projectID: </span><span class="value"> ... </span></li>
    	<li id="inputDatamodelID"><span>inputDatamodelID: </span><span class="value"> ... </span></li>
    	<li id="outputDatamodelID"><span>outputDatamodelID: </span><span class="value"> ... </span></li>
    	<li id="configurationID"><span>configurationID: </span><span class="value"> ... </span></li>
    <ul>
    
    <div style="margin-top:1em">
    	<button style="color:green" onClick="buildJobAndRunTask(false)">Build job from project and run task (Preview)</button>
    	<button style="color:red" onClick="buildJobAndRunTask(true)">Build job from project and run task</button>
    	<button style="color:grey" onClick="exportAsRDF(outputDatamodelID)">Export output model as RDF/XML</button>
    </div>
    
    <script type="text/javascript">
    
    /* SETTINGS */
	var baseUrlBackend = "http://127.0.0.1:8087/dmp/";
//    var baseUrlBackend = "http://sdvdmpdev.slub-dresden.de/dmp/";
    
    /* PARAMETERS */
    var projectID = "";
    var inputDatamodelID = "";
    var outputDatamodelID = "";
    var configurationID = "";
    
    var taskConfig = {};
    taskConfig.projectID = projectID;
    taskConfig.inputDatamodelID = inputDatamodelID;
    taskConfig.outputDatamodelID = outputDatamodelID;
    
    /* GLOBALS */
    var currentProject;
    var currentJob;
    var currentInputDatamodel;
    var currentOutputDatamodel;
    var currentConfig;
    var taskRequestCount = 0;
    var exportRequestCount = 0;
    var ingestRequestCount = 0;
    
    /* FUNCTIONS */
    
    var buildJob = function(project) {
    	var job = {};
    	job.name = "Job derived from project '" + project.name + "'";
    	job.mappings = project.mappings;
    	return job;
    };
    
    var buildTask = function(job, inputDatamodel, outputDatamodel) {
    	var task = {};
    	task.name = "" +
    		"Task (based on project '" + job.name + 
    		"', in: " +	inputDatamodel.id + 
    		", out: " + outputDatamodel.id;
    	task.job = job;
    	task.input_data_model = inputDatamodel;
    	task.output_data_model = outputDatamodel;
    	return task;
    };
    
    
    function updateParameterView() {
    	
    	contents.select("#projectID").select(".value").text(projectID);
    	contents.select("#inputDatamodelID").select(".value").text(inputDatamodelID);
    	contents.select("#outputDatamodelID").select(".value").text(outputDatamodelID);
    	contents.select("#configurationID").select(".value").text(configurationID);
    }
    
    function buildJobAndRunTask(persist) {
        
        // get project and build job
        d3.json(baseUrlBackend + "projects/" + projectID, function (error, result) {
        	
        	currentProject = result;
            currentJob = buildJob(currentProject);
        	//console.log(currentJob);
        	
            // get input data model
            d3.json(baseUrlBackend + "datamodels/" + inputDatamodelID, function (error, result) {
            	
                currentInputDatamodel = result;
            	//console.log(currentInputDatamodel);

                // get output data model
                d3.json(baseUrlBackend + "datamodels/" + outputDatamodelID, function (error, result) {
                	
                	currentOutputDatamodel = result;
                	//console.log(result);
                	currentTask = buildTask(currentJob, currentInputDatamodel, currentOutputDatamodel);
                	//console.log(currentTask);
                	//console.log(JSON.stringify(currentTask));
                	
                		// metrics
            			performance.mark('mark_start_post_task');

                	  	// run task
                	  	d3.xhr(baseUrlBackend + "tasks?persist=" + persist)
                	    .header("Content-Type", "application/json;charset=utf-8")
                	    .header("Accept", "application/json, text/plain, */*")
                	    .post(
                	        JSON.stringify(currentTask),
                	        function(err, rawData){
                	        	
                	        	// metrics
                        		performance.mark('mark_end_post_task');
                        		taskRequestCount++;
                        		performance.measure('measure_post_task_transformation_from_' + currentInputDatamodel.name + "_" + taskRequestCount, 'mark_start_post_task', 'mark_end_post_task');

								updateMetricsList();
                        		
//                        	    var t0 = performance.now();
//                        	    var t1 = performance.now();
//                        	    console.log("Call to doSomething took " + (t1 - t0) + " milliseconds.")
                	        	
                        		//console.log(rawData.response);
                	            var transformationResult = JSON.parse(rawData.response);
                    	  		console.log("Transformation results:");
                    	  		console.log(transformationResult);
                	        }
                	    );
                	
            	});	
        	}); 	
    	});   
    }
    
    function exportAsRDF(datamodelID) {
    	
		// metrics
		performance.mark('mark_start_export');
    	
	  	d3.xhr(baseUrlBackend + "datamodels/" + datamodelID + "/export?format=" + encodeURIComponent("application/rdf+xml"))
//	  	d3.xhr(baseUrlBackend + "datamodels/" + outputDatamodelID + "/export")
	    .header("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8")
//	    .header("Accept", "application/rdf+xml")
//	    .header("Accept", "application/octet-stream")
	    .get(
	        function(err, rawData) {
	        	
	        	// metrics
        		performance.mark('mark_end_export');
        		taskRequestCount++;
        		performance.measure('measure_export_from_' + datamodelID + "_" + exportRequestCount, 'mark_start_export', 'mark_end_export');
        		updateMetricsList();
        		
//	        	console.log(err);
    	  		console.log(rawData.response);
    	  		
//    	  		http://www.html5rocks.com/en/tutorials/file/filesystem/ and https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications 
//    	  		 if (rawData.status === 200) {
//    	  	        var blob = new Blob([rawData.response], {type: "application/rdf+xml"});
//    	  	        var objectUrl = URL.createObjectURL(blob);
//    	  	        window.open(objectUrl);
//    	  	    }
	        }
	    );
    }
    
    
    function ingestAsNewDataModel(resourceID) {
    	
    	console.log("Building datamodel from resource " + resourceID + " using the default config (XML/record) ... ");

        // get resource
        d3.json(baseUrlBackend + "resources/" + resourceID, function (error, resource) {

//        	console.log("resource: " + resource.name); 
        	
        		// get config
        		d3.json(baseUrlBackend + "configurations/" + configurationID, function (error, configuration) {

//            	console.log("config: " + configuration.name); 

		    	var configuredDatamodel = {
		    			"data_resource": resource ,
		    			"name" : "some name",
		    			"description" : "some desc",
		    			"configuration" : configuration
		    		};
		    	
//		    	console.log("configuredDatamodel:");  	console.log(configuredDatamodel); 
		    	
				// metrics
				performance.mark('mark_start_ingest');
		    	
			  	d3.xhr(baseUrlBackend + "datamodels")
			    .header("Content-Type", "application/json;charset=utf-8")
			    .header("Accept", "application/json, text/plain, */*")
			    .post(
			        JSON.stringify(configuredDatamodel),
			        function(err, rawData){
			        	console.log(err);
//		        		console.log(rawData.response);
			        	
						performance.mark('mark_end_ingest');
						ingestRequestCount++;
		        		performance.measure('measure_ingest_from_' + resource.name + "_" + ingestRequestCount, 'mark_start_ingest', 'mark_end_ingest');
		        		updateMetricsList();
						
			            var configurationResult = JSON.parse(rawData.response);
		    	  		console.log("configurationResult:");
		    	  		console.log(configurationResult);
			        }
			    );
		  	
	    	});
        		
    	});
    }
    
    function updateMetricsList() {
    	
		var updatedMeasurements = window.performance.getEntriesByType('measure');
		
//		for (var i = 0; i < items.length; ++i) {
//		  var req = items[i];
//		  console.log('Process step ' + req.name + ' took ' + formatedTime(req.duration));
//		}
    	
    	d3.select("#metricsView").selectAll("li").data(updatedMeasurements).enter().append("li")
    		.text(function(d) {console.log(d.duration); return d.name + ": " + formatedTime(d.duration) ; })
    		.call(highlightTemporarily);
    		;
    }
    
    function setCurrent(inputElement, className) {
    	d3.select("."+className).classed(className + " " + "currentSelection",false);
    	d3.select(inputElement.parentNode).classed(className + " " + "currentSelection",true);
    }
    
    function formatedTime(timeInMs) {
	    var mydate = new Date(timeInMs);
	    var hours = mydate.getUTCHours();
	    var minutes = mydate.getUTCMinutes();
	    var seconds = mydate.getUTCSeconds();
	    var formatedTime = "";
	    if (hours>0) formatedTime+=hours + "hours, ";
	    if (minutes>0) formatedTime+=minutes + " min and ";
	    if (seconds>0) {formatedTime+=seconds +" sec"} else {formatedTime = "< 1s"};
	    return formatedTime;
    }
    
    function highlightTemporarily(selection) {
    	selection.style("background-color", "lightgreen").transition().duration(1000).style("background-color", "white");
    }
    
    /* PAGE BUILDING */
    
    var contents = d3.select("body");
    
    updateParameterView();
    
    
    // list resources
    d3.json(baseUrlBackend + "resources", function (error, result) {
    	
    	contents.append("h2").text("Resources");
    	
    	var lis = contents
    		.append("div").append("ul")
    		.selectAll("li.resource")
    		.data(result)
    		;
    	
    	lis.enter()
    		.append("li")
    		.attr("class", "resource")
    		.text(function(d){ return d.name + " " ; })
    		.attr("title", function(d){ return d.description + " (" + d.uuid + ")"; })
    		;
    	
    	lis.append("button")
    		.attr("onclick", function(d){
    			return "setCurrent(this, 'resource'); ingestAsNewDataModel('" + d.uuid + "');";
   				})
			.text(function(d){return "Configure" ;})
			;
    	
    });
    
    // list configurations
    d3.json(baseUrlBackend + "configurations", function (error, result) {
    	
    	contents.append("h2").text("Configurations");
    	
    	var lis = contents
    		.append("div").append("ul")
    		.selectAll("li.configuration")
    		.data(result)
    		;
    	
    	lis.enter()
    		.append("li")
    		.attr("class", "configuration")
    		.text(function(d){ return d.name + " " ; })
    		.attr("title", function(d){ return d.description + " (" + d.uuid + ")"; })
    		;
    	
    	lis.append("button")
    		.attr("onclick", function(d){
    			return "setCurrent(this, 'configuration'); configurationID = '" + d.uuid + "'; updateParameterView() ; ";
   				})
			.text(function(d){return "Use for ingest" ;})
			;
    	
    });
    
    // list projects
    d3.json(baseUrlBackend + "projects", function (error, result) {
    	
    	contents.append("h2").text("Projects");
    	
    	var lis = contents
    		.append("div").append("ul")
    		.selectAll("li.project")
    		.data(result)
//    		.data(result.sort(function(a, b) { return d3.ascending(a.id, b.id); }))
    		;
    	
    	lis.enter()
    		.append("li")
    		.attr("class", "project")
    		.text(function(d){ return d.name + " " ; })
    		.attr("title", function(d){ return d.description + " (" + d.uuid + ")"; })
    		;
    	
    	lis.append("button")
    		.attr("onclick", function(d){
    			return "setCurrent(this, 'project'); projectID = '" + d.uuid + "'; updateParameterView() ; ";
   				})
			.text(function(d){return "Use for job" ;})
			;
    	
    });
    
    // list datamodels
    d3.json(baseUrlBackend + "datamodels", function (error, result) {
    	
    	contents.append("h2").text("Datamodels");
    	
    	var lis = contents
    		.append("div").append("ul")
    		.selectAll("li.datamodel")
    		.data(result)
    		;
    	
    	lis.enter()
    		.append("li")
    		.attr("class", "datamodel")
    		.text(function(d){ return d.description + " - " + d.name + " " ; })
    		.attr("title", function(d){ return d.uuid; })
    		;
    	
    	// input
    	lis.filter(function(d){return d.uuid.search("DataModel")==-1 ; })
    	.append("button")
		.attr("onclick", function(d){
			return "setCurrent(this, 'input') ; inputDatamodelID = '" + d.uuid + "'; updateParameterView() ; ";
				})
		.text(function(d){return "Use as input";})
		;
    	
    	// output
    	lis.filter(function(d){return d.uuid.search("DataModel")!=-1 ; })
		.append("button")
		.attr("onclick", function(d){
			return "setCurrent(this, 'output'); outputDatamodelID = '" + d.uuid + "'; updateParameterView() ; ";
				})
		.text(function(d){return "Use as output";})
		;
    	
    	// export
    	lis
		.append("button")
		.attr("onclick", function(d){
			return "exportAsRDF('" + d.uuid + "') ; ";
				})
		.text(function(d){return "Export as RDF/XML";})
		;

    	
    });

    </script>
    </body>
</html>
